name: Code Complexity and Quality Analysis

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze-complexity:
    name: Run Complexity and SonarQube Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for SonarQube analysis

      # ---------- Node.js Complexity (ESLint) ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install

      - name: Run ESLint Complexity Check
        id: eslint
        continue-on-error: true
        run: npm run lint > eslint-report.txt

      # ---------- Python Complexity (Radon) ----------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Radon
        run: pip install radon

      - name: Run Radon Complexity Check
        id: radon
        continue-on-error: true
        run: radon cc . -s -a > radon-report.txt

      # ---------- SonarQube Analysis ----------
      - name: Setup Java (required by SonarQube)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v3
        with:
          args: >
            -Dsonar.projectKey=complexity-demo
            -Dsonar.organization=your_org_name
            -Dsonar.sources=.
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # ---------- Combine All Reports ----------
      - name: Combine Reports
        run: |
          echo "==== ESLint Complexity Report ====" > complexity-report.txt
          cat eslint-report.txt >> complexity-report.txt
          echo "" >> complexity-report.txt
          echo "==== Radon Complexity Report ====" >> complexity-report.txt
          cat radon-report.txt >> complexity-report.txt
          echo "" >> complexity-report.txt
          echo "==== SonarQube Results ====" >> complexity-report.txt
          echo "Visit your SonarCloud dashboard for detailed analysis." >> complexity-report.txt

      - name: Upload Complexity Report
        uses: actions/upload-artifact@v4
        with:
          name: complexity-report
          path: complexity-report.txt

      # ---------- PR Comment ----------
      - name: Post PR Comment on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('complexity-report.txt', 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ **Complexity Alert!**\n\n\`\`\`\n${report.slice(0, 6500)}\n\`\`\`\nPlease simplify complex functions and check SonarQube for detailed metrics.`
            });
